<!DOCTYPE html>
<html>
<head>
  <title>Rajasthan Ispat Udyog - Customer Estimate Generator</title>
  <style>
    body { font-family: Arial; max-width: 950px; margin: 30px auto; background: #f6f9f9; }
    .heading { text-align: center; font-size: 2em; margin-bottom: 8px; font-weight: bold; color: #2e4372;}
    h2 { text-align: center; margin-top: 0;}
    table { width: 100%; border-collapse: collapse; margin: 20px 0 10px 0;}
    th, td { border: 1px solid #bbb; padding: 7px 6px; text-align: center;}
    th { background: #e0e7ef;}
    input, select, textarea { padding: 6px; border-radius: 3px; border: 1px solid #bbb; margin-bottom: 8px;}
    .form-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 7px;}
    .form-row label { min-width: 90px;}
    .btn { background: #2e4372; color: #fff; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; margin-right: 6px;}
    .btn:active { background: #1e2947;}
    .totals-row td { font-weight: bold; background: #e0e7ef;}
    .right { text-align: right;}
    .center { text-align: center;}
    .footer { text-align: center; color: #888; font-size: 0.95em; margin-top: 30px;}
    .remark-box { width: 100%;}
    .section { background: #fff; border-radius: 8px; box-shadow: 0 0 8px #ccc; padding: 18px 16px; }
    .print-save-btns { display: flex; justify-content: center; gap: 18px; margin-top: 25px;}
    .hide { display: none;}
    /* Customer details: Only 3 fields in 1st row */
    .customer-row {
      display: flex;
      gap: 18px;
      flex-wrap: wrap;
      margin-bottom: 7px;
      align-items: center;
    }
    .customer-row label { min-width: 110px; }
    .customer-row input[type="text"], 
    .customer-row input[type="date"] { width: 200px; }

    .email-row { display: flex; align-items: center; gap: 10px; margin-bottom: 7px;}
    .email-row label { min-width: 90px;}
    .email-row input[type="email"] { width: 300px;}
    @media (max-width: 700px) {
      body { max-width: 99vw;}
      .form-row, .customer-row, .email-row { flex-direction: column;}
      .customer-row label, .email-row label { min-width: 65px;}
      .customer-row input[type="text"], .customer-row input[type="date"], .email-row input[type="email"] { width: 100%;}
    }
    @media print {
      .print-save-btns, .btn, #queryForm, #estimateSection, .footer, .form-row, .customer-row, .email-row { display: none !important;}
      #printEstimateArea { box-shadow: none;}
      body { background: #fff;}
    }
  </style>
  <!-- Libraries for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="heading">Rajasthan Ispat Udyog</div>
  <h2>Customer Estimate Generator</h2>
  <div class="section">
    <!-- Customer Details -->
    <form id="queryForm" autocomplete="off" onsubmit="return false;">
      <div class="customer-row">
        <label>Customer Name</label>
        <input type="text" id="customerName" required>
        <label>Mobile</label>
        <input type="text" id="customerMobile">
        <label>Date</label>
        <input type="date" id="estimateDate">
      </div>
      <div class="email-row">
        <label>Email</label>
        <input type="email" id="customerEmail">
      </div>
      <!-- Product Query Section -->
      <h4 style="margin:8px 0 4px 0;">Add Product(s) for Estimate</h4>
      <div class="form-row">
        <label>Product</label>
        <select id="prodType">
          <option>Angle</option>
          <option>Beam</option>
          <option>Bar</option>
          <option>Channel</option>
          <option>HR Sheet</option>
          <option>HR Plate</option>
          <option>HR Coil</option>
          <option>NPB</option>
          <option>WBP</option>
          <option>Flats</option>
          <option>Square</option>
          <option>Other</option>
        </select>
        <label>Thickness (mm)</label>
        <input type="number" id="prodThick" step="0.01" style="width:70px;">
        <label>Width/Dia (mm)</label>
        <input type="number" id="prodWidth" step="0.01" style="width:70px;">
        <label>Length</label>
        <input type="number" id="prodLen" step="0.01" style="width:80px;">
        <select id="prodLenUnit" style="width:65px;">
          <option value="mm">MM</option>
          <option value="ft">Foot</option>
          <option value="m">Meter</option>
        </select>
        <label>Qty</label>
        <input type="number" id="prodQty" min="1" value="1" style="width:50px;">
        <button class="btn" type="button" onclick="addProduct()">Add Product</button>
      </div>
    </form>
    <div>
      <table id="prodTable">
        <thead>
          <tr>
            <th>S.No.</th>
            <th>Product</th>
            <th>Thickness</th>
            <th>Width/Dia</th>
            <th>Length</th>
            <th>Qty</th>
            <th>Weight/pc (kg)</th>
            <th>Total Wt (kg)</th>
            <th>Rate (₹/kg)</th>
            <th>Amount (₹)</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="prodTableBody"></tbody>
      </table>
    </div>
    <!-- Charges and Estimate Section -->
    <div id="estimateSection">
      <div class="form-row">
        <label>GST Type</label>
        <select id="gstType" style="width:170px;" onchange="updateGSTLabel()">
          <option value="local" selected>Intra-state (SGST+CGST)</option>
          <option value="igst">Inter-state (IGST)</option>
        </select>
        <label>Freight (₹)</label>
        <input type="number" id="freight" step="0.01" value="0">
        <label>Additional Charge (₹)</label>
        <input type="number" id="additionalCharge" step="0.01" value="0">
      </div>
      <div class="form-row">
        <label>Remarks</label>
        <textarea id="remarks" rows="2" class="remark-box"></textarea>
      </div>
      <div class="form-row">
        <button class="btn" type="button" onclick="generateEstimate()">Generate Estimate</button>
      </div>
      <div id="estimateResult"></div>
      <div class="print-save-btns hide" id="printBtns">
        <button class="btn" onclick="printEstimate()" type="button">Print Estimate</button>
        <button class="btn" onclick="savePDF()" type="button">Save as PDF</button>
      </div>
    </div>
  </div>
  <div class="footer">
    &copy; Rajasthan Ispat Udyog. All rights reserved.<br>
    This estimate is for informational purposes only.<br>
    Calculated and actual weights may differ by ±2-3% (up to ±5%) due to manufacturing tolerances.<br>
    Please verify all details before final order.<br>
  </div>
  <script>
    let products = [];

    function convertLengthToMM(val, unit) {
      if (unit === "mm") return val;
      if (unit === "ft") return val * 304.8;
      if (unit === "m") return val * 1000;
      return val;
    }

    function addProduct() {
      const prodType = document.getElementById('prodType').value;
      const t = parseFloat(document.getElementById('prodThick').value) || 0;
      const w = parseFloat(document.getElementById('prodWidth').value) || 0;
      const l = parseFloat(document.getElementById('prodLen').value) || 0;
      const lUnit = document.getElementById('prodLenUnit').value;
      const qty = parseInt(document.getElementById('prodQty').value) || 1;
      if (!prodType || t <= 0 || w <= 0 || l <= 0 || qty <= 0) {
        alert("Please enter valid product details!");
        return;
      }
      const rate = 0; // Default, user can input/edit after
      const l_mm = convertLengthToMM(l, lUnit);
      // Standard rectangle calculation
      const volPerPc = (t/10) * (w/10) * (l_mm/10);
      const density = 7.85; // g/cm³
      const wtPerPc = volPerPc * density / 1000;
      const totalWt = wtPerPc * qty;
      const amount = wtPerPc * qty * rate;

      products.push({
        prodType, t, w,
        l: l_mm,
        l_disp: l,
        l_unit: lUnit,
        qty,
        wtPerPc,
        calcWt: totalWt,
        rate,
        amount
      });
      updateProductsTable();
      clearProductInputs();
      document.getElementById('printBtns').classList.add('hide');
      document.getElementById('estimateResult').innerHTML = "";
    }

    function clearProductInputs() {
      document.getElementById('prodThick').value = "";
      document.getElementById('prodWidth').value = "";
      document.getElementById('prodLen').value = "";
      document.getElementById('prodQty').value = 1;
      document.getElementById('prodLenUnit').value = "mm";
    }

    function updateProductsTable() {
      const tbody = document.getElementById('prodTableBody');
      tbody.innerHTML = "";
      products.forEach((p, i) => {
        tbody.innerHTML += `<tr>
          <td>${i+1}</td>
          <td>${p.prodType}</td>
          <td>${p.t}</td>
          <td>${p.w}</td>
          <td>${p.l_disp} ${p.l_unit.toUpperCase()}</td>
          <td>${p.qty}</td>
          <td>${p.wtPerPc.toFixed(2)}</td>
          <td>${p.calcWt.toFixed(2)}</td>
          <td>
            <input type="number" id="rate_${i}" value="${p.rate || ""}" style="width:80px;" min="0" step="0.01" placeholder="₹/kg" onchange="updateAmount(${i})">
          </td>
          <td id="amt_${i}">${p.amount ? p.amount.toFixed(2) : "0.00"}</td>
          <td><button class="btn" style="background:#d13c3c;" onclick="deleteProduct(${i})">Delete</button></td>
        </tr>`;
      });
    }

    function updateAmount(idx) {
      const rate = parseFloat(document.getElementById(`rate_${idx}`).value) || 0;
      products[idx].rate = rate;
      products[idx].amount = rate * products[idx].calcWt;
      document.getElementById(`amt_${idx}`).textContent = products[idx].amount.toFixed(2);
    }

    function deleteProduct(idx) {
      products.splice(idx, 1);
      updateProductsTable();
      document.getElementById('printBtns').classList.add('hide');
      document.getElementById('estimateResult').innerHTML = "";
    }

    function updateGSTLabel() {
      // Optionally update GST label if you want to show different tax text
    }

    function generateEstimate() {
      if (products.length === 0) {
        alert('Please add at least one product!');
        return;
      }

      // Take customer details
      const cname = document.getElementById('customerName').value || "";
      const cemail = document.getElementById('customerEmail').value || "";
      const cmobile = document.getElementById('customerMobile').value || "";
      const estimateDate = document.getElementById('estimateDate').value || (new Date()).toISOString().slice(0,10);

      // Get all rate values (in case not changed)
      let totalTaxable = 0;
      products.forEach((p, i) => {
        let rate = parseFloat(document.getElementById(`rate_${i}`)?.value) || 0;
        products[i].rate = rate;
        products[i].amount = rate * products[i].calcWt;
        totalTaxable += products[i].amount;
      });

      const gstType = document.getElementById('gstType').value;
      let freight = parseFloat(document.getElementById('freight').value) || 0;
      let addl = parseFloat(document.getElementById('additionalCharge').value) || 0;
      let remarks = document.getElementById('remarks').value || '';
      let gstRate = 0.09; // 9%
      let sgst = gstType === 'local' ? totalTaxable * gstRate : 0;
      let cgst = gstType === 'local' ? totalTaxable * gstRate : 0;
      let igst = gstType === 'igst' ? totalTaxable * 2 * gstRate : 0;
      let gstTotal = sgst + cgst + igst;
      let grandTotal = totalTaxable + gstTotal + freight + addl;

      // Estimate HTML
      let html = `<div id="printEstimateArea">
      <div style="text-align:center; font-size:1.5em; font-weight:bold; margin-bottom:6px; color:#2e4372;">Rajasthan Ispat Udyog</div>
      <div style="text-align:center; font-size:1.08em; font-weight:bold; margin-bottom:12px;">ESTIMATE / QUOTATION</div>
      <div style="margin-bottom:12px;">
        <b>Customer:</b> ${cname || "-"} &nbsp; 
        <b>Email:</b> ${cemail || "-"} &nbsp; 
        <b>Mobile:</b> ${cmobile || "-"} &nbsp; 
        <b>Date:</b> ${estimateDate}
      </div>
      <table>
        <thead>
        <tr>
          <th>S.No.</th>
          <th>Product</th>
          <th>Specification</th>
          <th>Qty</th>
          <th>Weight/pc (kg)</th>
          <th>Total Wt (kg)</th>
          <th>Rate (₹/kg)</th>
          <th>Amount (₹)</th>
        </tr>
        </thead>
        <tbody>`;
      products.forEach((row, i) => {
        html += `<tr>
          <td>${i+1}</td>
          <td>${row.prodType}</td>
          <td>${row.t} × ${row.w} × ${row.l_disp} ${row.l_unit.toUpperCase()}</td>
          <td>${row.qty}</td>
          <td>${row.wtPerPc.toFixed(2)}</td>
          <td>${row.calcWt.toFixed(2)}</td>
          <td>${row.rate.toFixed(2)}</td>
          <td>${row.amount.toFixed(2)}</td>
        </tr>`;
      });
      html += `
        <tr class="totals-row"><td colspan="7" class="right">Taxable Value (₹)</td>
        <td>${totalTaxable.toFixed(2)}</td></tr>
        <tr><td colspan="7" class="right">SGST @9%</td><td>${sgst.toFixed(2)}</td></tr>
        <tr><td colspan="7" class="right">CGST @9%</td><td>${cgst.toFixed(2)}</td></tr>
        <tr><td colspan="7" class="right">IGST @18%</td><td>${igst.toFixed(2)}</td></tr>
        <tr><td colspan="7" class="right">Total GST</td><td>${gstTotal.toFixed(2)}</td></tr>
        <tr><td colspan="7" class="right">Freight Charge</td><td>${freight.toFixed(2)}</td></tr>
        <tr><td colspan="7" class="right">Additional Charge</td><td>${addl.toFixed(2)}</td></tr>
        <tr class="totals-row"><td colspan="7" class="right">Grand Total (₹)</td>
        <td>${grandTotal.toFixed(2)}</td></tr>
      </tbody></table>`;
      if (remarks.trim() !== "") {
        html += `<div><b>Remarks:</b> ${remarks}</div>`;
      }
      html += `<div style="font-size:0.95em;color:#888;margin-top:6px;">All amounts are in INR.<br>
      Rates are provisional and subject to confirmation.<br>
      GST and other taxes as applicable.<br>
      Please verify before finalizing the order.</div></div>`;
      document.getElementById('estimateResult').innerHTML = html;
      document.getElementById('printBtns').classList.remove('hide');
    }

    // Print Estimate Function
    function printEstimate() {
      const printContents = document.getElementById('printEstimateArea').innerHTML;
      const originalContents = document.body.innerHTML;
      document.body.innerHTML = printContents;
      window.print();
      document.body.innerHTML = originalContents;
      window.location.reload();
    }

    // Save as PDF Function (using jsPDF and html2canvas)
    function savePDF() {
      const { jsPDF } = window.jspdf;
      let doc = new jsPDF('l', 'pt', 'a4');
      let pdfArea = document.getElementById('printEstimateArea');
      html2canvas(pdfArea).then(function(canvas) {
        let imgData = canvas.toDataURL('image/png');
        let width = doc.internal.pageSize.getWidth();
        let height = (canvas.height * width) / canvas.width;
        doc.addImage(imgData, 'PNG', 20, 20, width - 40, height - 40);
        doc.save('Estimate_Rajasthan_Ispat.pdf');
      });
    }
  </script>
</body>
</html>